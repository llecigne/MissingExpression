//------------------------------------------------------------------------------
//--- Memoizer aspect ----------------------------------------------------------
//------------------------------------------------------------------------------
DEFAULT_KEY_GENERATOR = function(args)
{
    var key = '';
    var l = args.length;
    if (l > 0)
    {
	key = args[0].toString();
	for (var i = 1; i < l; i++)
	{
	    key += ',';
	    key += args[i].toString();
	}
    }
    return key;
}
Function.prototype.memoize = function(keyGenerator)
{
    var cache = {};
    if (!keyGenerator)
	keyGenerator = DEFAULT_KEY_GENERATOR;
    var memoizer = function() 
		   {
		      var key = keyGenerator(arguments);
		      var result = cache[key];
		      if (!result)
		      {
			  result = arguments.callee.callNext();
			  cache[key] = result;
		      }
		      return result;
		   };
    memoizer.cache = function() { return cache; };
    return this.applyAround(memoizer);
}   

//------------------------------------------------------------------------------
//--- Profiler aspect ----------------------------------------------------------
//------------------------------------------------------------------------------
Function.prototype.profile = function()
{
    var profiled = f.applyAround(function() 
		   {
		      var before = new Date();
		      result = arguments.callee.callNext();
		      callee.totalTreatmentTime += (new Date() - before);
		      callee.totalCalls += 1;
		      return result;
		   });
    profiled.averageTreatmentTime = function()
    {
	return this.totalTreatmentTime/this.totalCalls;
    }
    profiled.reset = function()
    {
	this.totalTreatmentTime = 0;
	this.totalCalls = 0;
    }
    profiled.display = function()
    {
	alert("Total calls: "+this.totalCalls+
	      "\n Average treatment time: "+this.averageTreatmentTime()+" ms");
    }
    profiled.reset();
    return profiled;
}

//------------------------------------------------------------------------------
//--- Busy Ajax request --------------------------------------------------------
//------------------------------------------------------------------------------
Ajax.BusyRequest = Class.create();
Ajax.BusyRequest.BUSY_OPTIONS = 
{
    onComplete: function()
    {
	arguments.callee.callNext();
	document.body.style.cursor = 'default'; 
    }
};
Ajax.BusyRequest.extend(Ajax.Request,
{
    initialize: function(url, params)
    {
	document.body.style.cursor = 'wait';
	Object.extend(params, Ajax.BusyRequest.BUSY_OPTIONS);
	arguments.callee.callNext();
    }
});
